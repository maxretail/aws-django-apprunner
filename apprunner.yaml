version: 1.0
runtime: python
build:
  commands:
    - pip install -r requirements.txt
    - python manage.py collectstatic --noinput
    - python manage.py migrate

run:
  command: gunicorn config.wsgi:application --bind 0.0.0.0:8000

service:
  name: ${APP_NAME}
  source:
    image:
      repository: ${ECR_REPO}
      tag: ${IMAGE_TAG}
      port: 8000
      environment:
        - name: DJANGO_SETTINGS_MODULE
          value: config.settings.production
        - name: DB_NAME
          value: ${APP_NAME}
        - name: DB_USER
          value: postgres
        - name: DB_PASSWORD
          value: ${DB_PASSWORD}
        - name: DB_HOST
          value: ${DB_HOST}
        - name: DB_PORT
          value: ${DB_PORT}
        - name: DJANGO_SECRET_KEY
          value: ${DJANGO_SECRET_KEY}
        - name: CSRF_TRUSTED_ORIGINS
          value: ${CSRF_TRUSTED_ORIGINS}
        - name: DJANGO_SUPERUSER_PASSWORD
          value: ${DJANGO_SECRET_KEY}
        - name: DJANGO_SUPERUSER_EMAIL
          value: ${DJANGO_SUPERUSER_EMAIL}

  auto_scaling:
    min_size: 1
    max_size: 5
    target_cpu: 70
    target_memory: 70 